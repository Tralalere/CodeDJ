Copied from Toxilibs.

Do not modify, except for adding new modes